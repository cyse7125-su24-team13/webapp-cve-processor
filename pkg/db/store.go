package db

import (
	"context"
	"encoding/json"
	"log"
	"mycveprocessor/pkg/cve"

	"github.com/jackc/pgx/v4"
)

func StoreCVERecord(conn *pgx.Conn, record cve.CVERecord) error {
	jsonData, err := json.Marshal(record)
	if err != nil {
		log.Printf("Failed to marshal JSON: %v\n", err)
		return err
	}

	_, err = conn.Exec(context.Background(), `
    INSERT INTO cve_records (cve_id, json_data, date_published, date_updated)
    VALUES ($1, $2, $3, $4)
    ON CONFLICT (cve_id, date_updated) DO UPDATE
    SET json_data = EXCLUDED.json_data
    `, record.CVEID, jsonData, record.DatePublished, record.DateUpdated)
	if err != nil {
		log.Printf("Failed to store CVE record: %v\n", err)
		return err
	}
	return nil
}
