package cve

import (
	"encoding/json"
	"io/ioutil"
	"log"
	"os"
	"time"
)

type CVERecord struct {
	CVEID         string    `json:"cveId"`
	JSONData      string    `json:"-"`
	DatePublished time.Time `json:"datePublished"`
	DateUpdated   time.Time `json:"dateUpdated"`
}

type CVEFile struct {
	CVEMetadata struct {
		CVEID         string `json:"cveId"`
		DatePublished string `json:"datePublished"`
		DateUpdated   string `json:"dateUpdated"`
	} `json:"cveMetadata"`
	Containers struct {
		CNA struct {
			// Add other fields as needed
		} `json:"cna"`
	} `json:"containers"`
}

func parseDate(dateStr string) (time.Time, error) {
	formats := []string{
		time.RFC3339,
		"2006-01-02T15:04:05",
		"2006-01-02",
	}

	var t time.Time
	var err error

	for _, format := range formats {
		t, err = time.Parse(format, dateStr)
		if err == nil {
			return t, nil
		}
	}

	return time.Time{}, err
}

func ParseCVEFile(filePath string) (CVERecord, error) {
	var cveFile CVEFile
	file, err := os.Open(filePath)
	if err != nil {
		log.Printf("Failed to open file: %v\n", err)
		return CVERecord{}, err
	}
	defer file.Close()

	byteValue, _ := ioutil.ReadAll(file)
	err = json.Unmarshal(byteValue, &cveFile)
	if err != nil {
		log.Printf("Failed to parse JSON: %v\n", err)
		return CVERecord{}, err
	}

	datePublished, err := parseDate(cveFile.CVEMetadata.DatePublished)
	if err != nil {
		log.Printf("Failed to parse datePublished: %v\n", err)
		return CVERecord{}, err
	}

	dateUpdated, err := parseDate(cveFile.CVEMetadata.DateUpdated)
	if err != nil {
		log.Printf("Failed to parse dateUpdated: %v\n", err)
		return CVERecord{}, err
	}

	log.Printf("datePublished: %v, dateUpdated: %v", datePublished.Format(time.RFC3339), dateUpdated.Format(time.RFC3339))
	return CVERecord{
		CVEID:         cveFile.CVEMetadata.CVEID,
		JSONData:      string(byteValue),
		DatePublished: datePublished,
		DateUpdated:   dateUpdated,
	}, nil
}
