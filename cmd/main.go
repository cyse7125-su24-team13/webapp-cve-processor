package main

import (
	"context"
	"log"
	"mycveprocessor/pkg/cve"
	"mycveprocessor/pkg/db"
	"os"
	"path/filepath"
)

func main() {
	database, err := db.Connect()
	if err != nil {
		log.Fatalf("Failed to connect to database: %v", err)
	}
	defer database.Close(context.Background())

	err = db.CreateSchema(database)
	if err != nil {
		log.Fatalf("Failed to create schema: %v", err)
	}
	//rootDir := "~/usr/data" // Replace with your root directory path
	rootDir := "./cvetest" // Replace with your root directory path
	err = filepath.Walk(rootDir, func(path string, info os.FileInfo, err error) error {
		if err != nil {
			return err
		}
		if !info.IsDir() && filepath.Ext(path) == ".json" {
			cveRecord, err := cve.ParseCVEFile(path)
			if err != nil {
				log.Printf("Failed to parse CVE file: %v", err)
				return nil // Continue processing other files
			}

			err = db.StoreCVERecord(database, cveRecord)
			if err != nil {
				log.Printf("Failed to store CVE record: %v", err)
			}
		}
		return nil
	})
	if err != nil {
		log.Fatalf("Error walking the path %q: %v\n", rootDir, err)
	}
}
